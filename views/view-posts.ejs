<%- include("partials/header.ejs") %>


<div id="post-list">
    <a href="/<%= channel_id %>/new-post" class="btn btn-primary mb-3">–°—ä–∑–¥–∞–π –Ω–æ–≤ –ø–æ—Å—Ç</a>
    
    <% if (posts && posts.length > 0) { %>
        <% posts.forEach((post) => { %>
            <div class="post mb-4" data-title="<%= post.title %>">
                <h2 class="pb-2 text-left"><%= post.title %></h2>
                <p class="text-left"><%= post.content %></p>
                <p class="text-left"><%= post.author %></p>
                
                <% if (post.date_of_last_edit) { %>
                    <p class="text-center">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–æ –Ω–∞: <%= post.date_of_last_edit %></p>
                <% } else { %>
                    <p class="text-center">–°—ä–∑–¥–∞–¥–µ–Ω–æ –Ω–∞: <%= post.date_of_creation %></p>
                <% } %>

                <a href="/<%= channel_id %>/edit/<%= post.post_id %>" class="edit-button">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ</a>
                <a href="/<%= channel_id %>/delete-post/<%= post.post_id %>" class="delete-button">–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ</a>

                <button class="button" onclick="toggleReplyForm(this)">–û—Ç–≥–æ–≤–æ—Ä–∏</button>
                <div class="reply-form hidden">
                    <textarea class="form-control" rows="2" placeholder="Write your reply here..."></textarea>
                    <button class="edit-button" onclick="submitReply(this)">–ü—É–±–ª–∏–∫—É–≤–∞–π –æ—Ç–≥–æ–≤–æ—Ä–∞</button>
                </div>
                <div class="replies"></div>
            </div>
        <% }); %>
    <% } else { %>
        <p>–ù—è–º–∞ –ø–æ—Å—Ç–æ–≤–µ –≤ —Ç–æ–∑–∏ –∫–∞–Ω–∞–ª.</p>
    <% } %>
</div>


<div id="new-post-form" style="display: none;">
    <input type="text" id="post-title" placeholder="Post Title">
    <textarea id="post-content" placeholder="Post Content"></textarea>
    <button  class="edit-button" onclick="createPost()">–°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –ø–æ—Å—Ç</button>
</div>

<script>
    function toggleReplyForm(button) {
        const replyForm = button.nextElementSibling;
        replyForm.classList.toggle('hidden');
    }

    function submitReply(button) {
        const replyText = button.previousElementSibling.value;
        const repliesDiv = button.parentElement.nextElementSibling;

        if (replyText.trim()) {
            const replyDiv = document.createElement('div');
            replyDiv.classList.add('reply');
            replyDiv.innerHTML = `
                <p>${replyText}</p>
                <span class="thumbs" onclick="markHelpful(this, true)">üëç</span>
                <span class="thumbs" onclick="markHelpful(this, false)">üëé</span>
                <span class="helpful-count">Helpful: 0</span>
                <span class="not-helpful-count">Not Helpful: 0</span>
            `;
            repliesDiv.appendChild(replyDiv);
            button.parentElement.classList.add('hidden');
            button.previousElementSibling.value = '';
        } else {
            alert('Reply cannot be empty.');
        }
    }

    function markHelpful(thumb, isHelpful) {
        const replyDiv = thumb.parentElement;
        const thumbs = replyDiv.querySelectorAll('.thumbs');
        const helpfulCountSpan = replyDiv.querySelector('.helpful-count');
        const notHelpfulCountSpan = replyDiv.querySelector('.not-helpful-count');

        if (thumb.classList.contains('disabled')) return;

        if (isHelpful) {
            let currentHelpfulCount = parseInt(helpfulCountSpan.textContent.split(': ')[1]);
            helpfulCountSpan.textContent = `Helpful: ${currentHelpfulCount + 1}`;
        } else {
            let currentNotHelpfulCount = parseInt(notHelpfulCountSpan.textContent.split(': ')[1]);
            notHelpfulCountSpan.textContent = `Not Helpful: ${currentNotHelpfulCount + 1}`;
        }

        thumbs.forEach(t => t.classList.add('disabled'));
    }

    function toggleNewPostForm() {
        const newPostForm = document.getElementById('new-post-form');
        newPostForm.style.display = newPostForm.style.display === 'none' ? 'block' : 'none';
    }

    function createPost() {
        const title = document.getElementById('post-title').value;
        const content = document.getElementById('post-content').value;
        const postList = document.getElementById('post-list');

        if (title && content) {
            const postDiv = document.createElement('div');
            postDiv.classList.add('post');
            postDiv.setAttribute('data-title', title);
            postDiv.innerHTML = `
                <h2>${title}</h2>
                <p>${content}</p>
                <button onclick="toggleReplyForm(this)">Reply</button>
                <div class="reply-form hidden">
                    <textarea placeholder="Write your reply"></textarea>
                    <button onclick="submitReply(this)">Submit Reply</button>
                </div>
                <div class="replies"></div>
            `;
            postList.appendChild(postDiv);
            document.getElementById('new-post-form').style.display = 'none'; // Hide form
            document.getElementById('post-title').value = '';
            document.getElementById('post-content').value = '';
        } else {
            alert('Please fill out both fields.');
        }
    }

    function searchPosts(event) {
        event.preventDefault();
        const searchText = document.getElementById('search-input').value.toLowerCase();
        const posts = document.querySelectorAll('#post-list .post');
        posts.forEach(post => {
            const postTitle = post.getAttribute('data-title').toLowerCase();
            if (postTitle.includes(searchText)) {
                post.style.display = '';
            } else {
                post.style.display = 'none';
            }
        });
    }

    document.getElementById('search-form').addEventListener('submit', searchPosts);
</script>

<%- include("partials/footer.ejs") %>
